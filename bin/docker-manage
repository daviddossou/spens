#!/bin/bash

# Docker management script for Spens

case $1 in
  "up")
    echo "ğŸš€ Starting all services..."
    docker-compose up
    ;;
  "down")
    echo "ğŸ›‘ Stopping all services..."
    docker-compose down
    ;;
  "restart")
    if [ -z "$2" ]; then
      echo "ğŸ”„ Restarting all services..."
      docker-compose down
      docker-compose up -d
    else
      echo "ğŸ”„ Restarting $2 service..."
      docker-compose restart "$2"
    fi
    ;;
  "logs")
    service=${2:-web}
    echo "ğŸ“„ Following logs for $service..."
    docker-compose logs -f $service
    ;;
  "console")
    echo "ğŸ¯ Opening Rails console..."
    docker-compose exec web bin/rails console
    ;;
  "shell")
    echo "ğŸš Opening shell in web container..."
    docker-compose exec web bash
    ;;
  "test")
    if [ -z "$2" ]; then
      echo "ğŸ§ª Running all tests..."
      docker-compose exec web bundle exec rspec
    else
      echo "ğŸ§ª Running specific test: $2"
      docker-compose exec web bundle exec rspec "$2"
    fi
    ;;
  "bundle")
    if [ -z "$2" ]; then
      echo "ğŸ’ Running bundle install..."
      docker-compose exec web bundle install
    else
      echo "ğŸ’ Running bundle $2..."
      docker-compose exec web bundle "$2"
    fi
    ;;
  "rails")
    if [ -z "$2" ]; then
      echo "ğŸš‚ Opening Rails console..."
      docker-compose exec web bin/rails console
    else
      echo "ğŸš‚ Running Rails command: $2 $3 $4 $5 $6 $7 $8 $9"
      docker-compose exec web bin/rails "$2" "$3" "$4" "$5" "$6" "$7" "$8" "$9"
    fi
    ;;
  "migrate")
    echo "ğŸ—„ï¸  Running migrations..."
    docker-compose exec web bin/rails db:migrate
    ;;
  "rollback")
    if [ -z "$2" ]; then
      echo "ğŸ” Rolling back the latest migration file..."
      docker-compose exec web bin/rails db:rollback
    else
      echo "ğŸ” Rolling back to a specific migration: $2"
      docker-compose exec web bin/rails db:rollback STEP=$2
    fi
    ;;
  "seed")
    echo "ğŸŒ± Seeding database..."
    docker-compose exec web bin/rails db:seed
    ;;
  "reset")
    echo "ğŸ’¥ Resetting database..."
    docker-compose exec web bin/rails db:reset
    ;;
  "build")
    echo "ğŸ”¨ Building containers..."
    docker-compose build
    ;;
  "test-watch")
    echo "ğŸ‘€ Running tests in watch mode..."
    docker-compose exec web bundle exec rspec --format documentation --color --fail-fast
    ;;
  "test-debug")
    echo "ğŸ› Running tests with debugging enabled..."
    docker-compose exec web bundle exec rspec --format documentation --color --backtrace
    ;;
  "clean")
    echo "ğŸ§¹ Cleaning up containers and volumes..."
    docker-compose down -v
    docker system prune -f
    ;;
  *)
    echo "ğŸ³ Spens Docker Management"
    echo ""
    echo "Usage: ./bin/docker-manage [command]"
    echo ""
    echo "Commands:"
    echo "  up        Start all services"
    echo "  down      Stop all services"
    echo "  restart   Restart all services (or specify service: web, sidekiq, db, redis)"
    echo "  logs      Follow logs (specify service: web, sidekiq, db, redis)"
    echo "  console   Open Rails console"
    echo "  shell     Open bash shell in web container"
    echo "  bundle    Run bundle commands (install by default, or specify: update, etc.)"
    echo "  rails     Run Rails commands (console by default, or generators, etc.)"
    echo "  test      Run RSpec tests (optionally specify file/pattern)"
    echo "  test-watch Run tests with detailed output and fail-fast"
    echo "  test-debug Run tests with debugging and full backtrace"
    echo "  migrate   Run database migrations"
    echo "  seed      Seed the database"
    echo "  reset     Reset database (drop, create, migrate, seed)"
    echo "  build     Build Docker containers"
    echo "  clean     Clean up containers and volumes"
    echo ""
    echo "Examples:"
    echo "  ./bin/docker-manage up"
    echo "  ./bin/docker-manage restart web                    # Restart only web service"
    echo "  ./bin/docker-manage logs sidekiq"
    echo "  ./bin/docker-manage console"
    echo "  ./bin/docker-manage bundle                         # Run bundle install"
    echo "  ./bin/docker-manage bundle update                  # Run bundle update"
    echo "  ./bin/docker-manage rails                          # Open Rails console"
    echo "  ./bin/docker-manage rails generate model User      # Generate a model"
    echo "  ./bin/docker-manage rails generate view_component:install # Install ViewComponent"
    echo "  ./bin/docker-manage rails db:migrate               # Run migrations"
    echo "  ./bin/docker-manage test                           # Run all tests"
    echo "  ./bin/docker-manage test spec/models/user_spec.rb  # Run specific file"
    echo "  ./bin/docker-manage test spec/models               # Run all model tests"
    echo "  ./bin/docker-manage test spec/models/user_spec.rb:25 # Run specific line"
    echo "  ./bin/docker-manage test-watch                     # Run with detailed output"
    echo "  ./bin/docker-manage test-debug                     # Run with full debugging"
    ;;
esac
